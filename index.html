<!DOCTYPE html>
<html>
<head>
  <title>WebSocket demo</title>
</head>
<body>
  <script>
   var ws = new WebSocket("ws://127.0.0.1:8765/");
   ws.binaryType = 'arraybuffer';

   ws.onopen = function(event) {
     const node = document.getElementById("input");
     node.addEventListener("keyup", function(event) {
       if (event.key === "Enter") {
         sendMessage(node.value);
       }
     });
   }

   ws.onmessage = function(e) {
     var event = JSON.parse(e.data);
     if (event[0] === 'audio') {
       processChunk(event[1]);
     } else if (event[0] === 'msg') {
       showMessage(`${event[1]}: ${event[2]}`);
     } else if (event[0] === 'join') {
       showMessage(`${event[1]} has arrived! :-)`);
     } else if (event[0] === 'leave') {
       showMessage(`${event[1]} has departed. :-(`);
     }
   }

   ws.onclose = function(e) {
     micProcessor.disconnect();
   }

   // Protocol types.
   const AUDIO = 0;
   const MESSAGE = 1;

   function sendMessage(msg) {
     var strbuf = new TextEncoder("utf-8").encode(msg);
     var packet = new Uint8Array(strbuf.length + 1);
     packet.subarray(1).set(strbuf);
     packet[0] = MESSAGE;
     ws.send(packet);
   }

   function showMessage(msg) {
     console.log(msg);
     var messages = document.getElementsByTagName('ul')[0],
         message = document.createElement('li'),
         content = document.createTextNode(msg);
     message.appendChild(content);
     messages.appendChild(message);
     document.body.appendChild(messages);
   }

   function sendChunk(chunk) {
     var packet = new Uint8Array(chunk.buffer.byteLength + 1);
     packet.subarray(1).set(new Uint8Array(chunk.buffer));
     packet[0] = AUDIO;
     ws.send(packet);
   }

   var data = [];
   function processChunk(chunk) {
     data.push(...chunk);
   }

   // create web audio api context
   var audioCtx = new (window.AudioContext || window.webkitAudioContext)();

   const bufferSize = 1024;
   var micProcessor;

   const handleSuccess = function(stream) {
     // Got permission to use the mic - upload samples to server.
     const source = audioCtx.createMediaStreamSource(stream);
     micProcessor = audioCtx.createScriptProcessor(bufferSize, 1, 0);

     source.connect(micProcessor);
     micProcessor.connect(audioCtx.destination);

     micProcessor.onaudioprocess = function(e) {
       sendChunk(e.inputBuffer.getChannelData(0));
     };
   };

   navigator.mediaDevices.getUserMedia({ audio: true, video: false })
       .then(handleSuccess);

   // Play received data from server.
   remoteProcessor = audioCtx.createScriptProcessor(bufferSize, 0, 1);
   remoteProcessor.onaudioprocess = function (e) {
     var out = e.outputBuffer.getChannelData(0);
     var n = Math.min(out.length, data.length);
     for (var i = 0; i < n; i++) {
       out[i] = data[i];
     }
     data.splice(0, n);
   }

   remoteProcessor.connect(audioCtx.destination);
  </script>
  <ul></ul>
  <input id="input" type="text" />
  <input type="file" accept="audio/*" capture id="recorder">
</body>
</html>
